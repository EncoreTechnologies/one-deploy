---
- name: Set network manager config facts
  ansible.builtin.set_fact:
    current_nm_config: "{{ networkmanager_config[conn_type][conn.key]  }}"

- name: Check if networkmanager config file exists
  ansible.builtin.stat:
    path: "/etc/NetworkManager/system-connections/{{ conn.key }}.nmconnection"
  register: nm_file_stat
  tags:
    - connections

- when: nm_file_stat.stat.exists
  block:
    - name: Read existing file
      ansible.builtin.slurp:
        src: "/etc/NetworkManager/system-connections/{{ conn.key }}.nmconnection"
      register: current_file
      tags:
        - connections
    
    - name: Convert ini to yaml to compare against settings
      ansible.builtin.set_fact:
        current_nm_file_contents: "{{ current_file.content | b64decode | community.general.from_ini | from_yaml }}"
      tags:
        - connections

    - name: Compare file settings to current config
      set_fact:
        update_nm_conn: "{{ (current_nm_config | to_nice_json != current_nm_file_contents | to_nice_json) | bool }}"

    - name: Set facts for fail types
      ansible.builtin.set_fact:
        is_connection_fail: "{{ _is_connection_fail | trim | bool }}"
      vars:
        _is_connection_fail: |
          {% if conn_type == 'bridges' and fail_on_nm_bridge_change %}
          true
          {% elif conn_type == 'bonds' and fail_on_nm_bond_change %}
          true
          {% elif conn_type == 'vlans' and fail_on_nm_vlan_change %}
          true
          {% elif conn_type == 'ethernets' and fail_on_nm_ethernet_change %}
          true
          {% else %}
          false
          {% endif %}
      tags:
        - connections

    - when: conn_type == 'bridges'
      block:
        - name: Get list of running VMs
          register: running_vms
          changed_when: false
          ansible.builtin.command: virsh list --name
          tags:
            - connections

        - name: Filter out empty lines from VM list
          ansible.builtin.set_fact:
            vm_names: "{{ running_vms.stdout_lines | select('match', '^.+$') | list }}"
          tags:
            - connections

        - name: Get nic info from vms
          changed_when: false
          loop: "{{ vm_names }}"
          loop_control:
            loop_var: vm_name
          register: vm_interface_shell
          ansible.builtin.shell: |
            virsh domiflist {{ vm_name }} | tail -n +3 | awk '$2 == "bridge" { print $3 }'
          tags:
            - connections

        - name: "Determine if any nics are connected to bridge {{ conn.key }}"
          set_fact: 
            is_vm_using_bridge: |
              {{
                conn.key in 
                vm_interface_shell.results 
                | map(attribute='stdout_lines') 
                | list 
                | flatten 
                | unique 
                | list
              }}

        - name: Update connection fail fact
          when:
            - not is_vm_using_bridge
            - bridge_change_override
          ansible.builtin.set_fact:
            is_connection_fail: false
          tags:
            - connections

    - name: Compare network contents
      ansible.builtin.fail:
        msg: |
          Connection type "{{ conn_type }}" is set to fail on any changes.
          The reason for this setting is that any changes to network settings causes outages for vms.
          Check the README.md in "connections" role of the one_deploy collection for more details
      when: 
        - update_nm_conn
        - is_connection_fail
      tags:
        - connections

- name: Update networkmanager connection fact
  set_fact:
    update_nm_conn: true
  when: current_nm_file_contents is not defined or current_nm_file_contents == ''

- when: 
    - apply_network_change
    - update_nm_conn
  block:
    - name: "Create/update {{ conn.key }}.nmconnection file"
      ansible.builtin.copy:
        content: "{{ current_nm_config | community.general.to_ini }}"
        dest: "/etc/NetworkManager/system-connections/{{ conn.key }}.nmconnection"
        owner: root
        group: root
        mode: '0600'
      tags:
        - connections

    - name: "Reload and bring up connection {{ conn.key }}"
      ansible.builtin.shell: |
        nmcli c reload
        nmcli c up {{ conn.key }}
      tags:
        - connections

- name: Unset network manager variables
  set_fact:
    current_nm_file_contents: ''